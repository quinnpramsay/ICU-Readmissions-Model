CREATE OR REPLACE TABLE 
  `model_data.icu_survivors` AS
SELECT 
  ie.subject_id,
  ie.hadm_id,
  ie.stay_id,
  ie.intime,
  ie.outtime,
  ie.los as length_of_stay,
  a.admittime,
  a.dischtime,
  a.discharge_location,
  a.admission_type,
  a.admission_location,
  p.anchor_age,
  p.anchor_year,
  p.gender,
  (p.anchor_year - p.anchor_age) AS birth_year,
  (EXTRACT(YEAR FROM a.admittime) - (p.anchor_year - p.anchor_age)) AS age
FROM 
  `physionet-data.mimiciv_icu.icustays` ie
INNER JOIN 
  `physionet-data.mimiciv_hosp.admissions` a
  ON ie.hadm_id = a.hadm_id
INNER JOIN 
  `physionet-data.mimiciv_hosp.patients` p
  ON ie.subject_id = p.subject_id
WHERE 
  a.hospital_expire_flag = 0;
