CREATE OR REPLACE TABLE 
  `model_data.icu_survivors` AS
WITH drg_first AS (
  SELECT 
    hadm_id,
    drg_severity,
    drg_mortality,
    ROW_NUMBER() OVER (PARTITION BY hadm_id ORDER BY drg_code) AS rn
  FROM `physionet-data.mimiciv_3_1_hosp.drgcodes`
),
prior_icu_info AS (
  SELECT
    ie.subject_id,
    ie.intime as current_intime,
    COUNT(DISTINCT ie_prior.stay_id) as prior_icu_admits_last_year,
    MAX(ie_prior.outtime) as last_icu_outtime
  FROM
    `physionet-data.mimiciv_3_1_icu.icustays` ie
  LEFT JOIN
    `physionet-data.mimiciv_3_1_icu.icustays` ie_prior
    ON ie.subject_id = ie_prior.subject_id
    AND ie_prior.intime < ie.intime
    AND DATETIME_DIFF(ie.intime, ie_prior.intime, DAY) <= 365
  GROUP BY
    ie.subject_id, ie.intime
),
procedure_counts AS (
  SELECT
    hadm_id,
    COUNT(DISTINCT icd_code) as num_procedures
  FROM
    `physionet-data.mimiciv_3_1_hosp.procedures_icd`
  GROUP BY
    hadm_id
),
diagnosis_counts AS (
  SELECT
    hadm_id,
    COUNT(DISTINCT icd_code) as num_diagnoses
  FROM
    `physionet-data.mimiciv_3_1_hosp.diagnoses_icd`
  GROUP BY
    hadm_id
),
comorbidities AS (
  SELECT
    hadm_id,
    MAX(CASE WHEN icd_code LIKE 'I50%' OR icd_code LIKE '428%' THEN 1 ELSE 0 END) as chf,
    MAX(CASE WHEN icd_code LIKE 'I25%' OR icd_code LIKE '414%' THEN 1 ELSE 0 END) as cad,
    MAX(CASE WHEN icd_code LIKE 'E11%' OR icd_code LIKE '250%' THEN 1 ELSE 0 END) as diabetes,
    MAX(CASE WHEN icd_code LIKE 'J44%' OR icd_code LIKE '496%' THEN 1 ELSE 0 END) as copd,
    MAX(CASE WHEN icd_code LIKE 'N18%' OR icd_code LIKE '585%' THEN 1 ELSE 0 END) as ckd,
    MAX(CASE WHEN icd_code LIKE 'I48%' OR icd_code LIKE '4273%' THEN 1 ELSE 0 END) as afib,
    MAX(CASE WHEN icd_code LIKE 'C%' OR icd_code LIKE '1%' OR icd_code LIKE '2%' THEN 1 ELSE 0 END) as cancer
  FROM
    `physionet-data.mimiciv_3_1_hosp.diagnoses_icd`
  GROUP BY
    hadm_id
),
omr_pivot AS (
  SELECT 
    subject_id,
    chartdate,
    COALESCE(
      MAX(CASE WHEN result_name = 'Height (Inches)' THEN SAFE_CAST(result_value AS FLOAT64) END),
      MAX(CASE WHEN result_name = 'Height' THEN SAFE_CAST(result_value AS FLOAT64) END)
    ) as height_inches,
    COALESCE(
      MAX(CASE WHEN result_name = 'Weight (Lbs)' THEN SAFE_CAST(result_value AS FLOAT64) END),
      MAX(CASE WHEN result_name = 'Weight' THEN SAFE_CAST(result_value AS FLOAT64) END)
    ) as weight_lbs,
    COALESCE(
      MAX(CASE WHEN result_name = 'BMI (kg/m2)' THEN SAFE_CAST(result_value AS FLOAT64) END),
      MAX(CASE WHEN result_name = 'BMI' THEN SAFE_CAST(result_value AS FLOAT64) END)
    ) as bmi,
    MAX(CASE WHEN result_name = 'eGFR' THEN 
      SAFE_CAST(
        CASE 
          WHEN result_value LIKE '>%' THEN REGEXP_REPLACE(result_value, r'[^0-9.]', '')
          WHEN result_value LIKE '<%' THEN REGEXP_REPLACE(result_value, r'[^0-9.]', '')
          ELSE result_value
        END AS FLOAT64
      )
    END) as egfr,
    COALESCE(
      MAX(CASE WHEN result_name = 'Blood Pressure' THEN result_value END),
      MAX(CASE WHEN result_name = 'Blood Pressure Sitting' THEN result_value END),
      MAX(CASE WHEN result_name = 'Blood Pressure Lying' THEN result_value END)
    ) as blood_pressure
  FROM 
    `physionet-data.mimiciv_3_1_hosp.omr`
  GROUP BY
    subject_id, chartdate
),
omr_baseline AS (
  SELECT 
    o.subject_id,
    ie.stay_id,
    o.height_inches,
    o.weight_lbs,
    o.bmi,
    o.egfr,
    o.blood_pressure,
    ROW_NUMBER() OVER (
      PARTITION BY ie.stay_id 
      ORDER BY ABS(DATETIME_DIFF(ie.intime, DATETIME(o.chartdate), DAY))
    ) as rn
  FROM 
    omr_pivot o
  INNER JOIN
    `physionet-data.mimiciv_3_1_icu.icustays` ie
    ON o.subject_id = ie.subject_id
    AND o.chartdate <= DATE(ie.intime)
    AND o.chartdate >= DATE_SUB(DATE(ie.intime), INTERVAL 365 DAY)
  WHERE
    o.height_inches IS NOT NULL 
    OR o.weight_lbs IS NOT NULL 
    OR o.bmi IS NOT NULL 
    OR o.egfr IS NOT NULL 
    OR o.blood_pressure IS NOT NULL
),
icu_with_next AS (
  SELECT 
    ie.subject_id,
    ie.hadm_id,
    ie.stay_id,
    ie.intime,
    ie.outtime,
    ie.los as length_of_stay,
    a.admittime,
    a.dischtime,
    a.discharge_location,
    a.admission_type,
    a.admission_location,
    p.anchor_age,
    p.anchor_year,
    p.gender,
    d.drg_severity,
    d.drg_mortality,
    (p.anchor_year - p.anchor_age) AS birth_year,
    (EXTRACT(YEAR FROM a.admittime) - (p.anchor_year - p.anchor_age)) AS age,
    DATETIME_DIFF(a.dischtime, a.admittime, DAY) as hospital_days,
    COALESCE(pic.prior_icu_admits_last_year, 0) as prior_icu_admits_last_year,
    COALESCE(DATETIME_DIFF(ie.intime, pic.last_icu_outtime, DAY), 999) as days_since_last_icu,
    COALESCE(pc.num_procedures, 0) as num_procedures,
    COALESCE(dc.num_diagnoses, 0) as num_diagnoses,
    COALESCE(cm.chf, 0) as chf,
    COALESCE(cm.cad, 0) as cad,
    COALESCE(cm.diabetes, 0) as diabetes,
    COALESCE(cm.copd, 0) as copd,
    COALESCE(cm.ckd, 0) as ckd,
    COALESCE(cm.afib, 0) as afib,
    COALESCE(cm.cancer, 0) as cancer,
    ob.height_inches,
    ob.weight_lbs,
    ob.bmi,
    ob.egfr,
    ob.blood_pressure,
    CASE 
      WHEN ie.los < 1 THEN 0
      WHEN ie.los < 3 THEN 1
      WHEN ie.los < 7 THEN 2
      ELSE 3
    END AS los_category,
    LEAD(ie.intime) OVER (PARTITION BY ie.subject_id ORDER BY ie.intime) AS next_icu_intime
  FROM 
    `physionet-data.mimiciv_3_1_icu.icustays` ie
  INNER JOIN 
    `physionet-data.mimiciv_3_1_hosp.admissions` a
    ON ie.hadm_id = a.hadm_id
  INNER JOIN 
    `physionet-data.mimiciv_3_1_hosp.patients` p
    ON ie.subject_id = p.subject_id
  LEFT JOIN
    drg_first d
    ON ie.hadm_id = d.hadm_id AND d.rn = 1
  LEFT JOIN
    prior_icu_info pic
    ON ie.subject_id = pic.subject_id AND ie.intime = pic.current_intime
  LEFT JOIN
    procedure_counts pc
    ON ie.hadm_id = pc.hadm_id
  LEFT JOIN
    diagnosis_counts dc
    ON ie.hadm_id = dc.hadm_id
  LEFT JOIN
    comorbidities cm
    ON ie.hadm_id = cm.hadm_id
  LEFT JOIN
    omr_baseline ob
    ON ie.stay_id = ob.stay_id AND ob.rn = 1
  WHERE 
    a.hospital_expire_flag = 0
)
SELECT
  *,
  CASE 
    WHEN DATETIME_DIFF(next_icu_intime, outtime, DAY) <= 30
         AND DATETIME_DIFF(next_icu_intime, outtime, DAY) >= 1
    THEN 1
    ELSE 0
  END AS readmitted_30day
FROM icu_with_next;
